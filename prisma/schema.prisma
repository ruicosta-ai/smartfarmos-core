generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String     @id @default(cuid())
  email        String     @unique
  passwordHash String
  name         String
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  farms        UserFarm[]
}

enum WeatherProvider {
  WU
}

enum IntegrationKind {
  WUNDERGROUND
  // FUTURO: MODBUS_RTU
  // FUTURO: MODBUS_TCP
  // FUTURO: ZIGBEE
  // FUTURO: MQTT_BRIDGE
}

enum IntegrationStatus {
  DISABLED
  PENDING
  RUNNING
  ERROR
}

model Farm {
  id        String   @id @default(cuid())
  name      String
  location  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Integração meteorológica (opcional)
  weatherProvider  WeatherProvider?
  weatherStationId String?

  sensors Sensor[]
  users   UserFarm[]
  nuc     Nuc?    @relation("FarmNuc")
}

model Nuc {
  id     String  @id @default(cuid())
  farmId String?
  farm   Farm?   @relation("FarmNuc", fields: [farmId], references: [id])

  name          String?
  status        String    @default("offline") // "online" | "offline"
  lastHeartbeat DateTime?
  agentVersion  String?
  endpoint      String?
  integrations NucIntegration[]

  // Claim code (guardado com hash + expiração)
  claimCodeHash      String?
  claimCodeExpiresAt DateTime?

  // (opcional) auditoria simples
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([farmId])
}

model UserFarm {
  userId String
  farmId String
  role   Role   @default(WORKER)
  user   User   @relation(fields: [userId], references: [id])
  farm   Farm   @relation(fields: [farmId], references: [id])

  @@id([userId, farmId])
}

enum Role {
  OWNER
  MANAGER
  WORKER
  VIEWER
}

model Sensor {
  id        String    @id @default(cuid())
  farmId    String
  farm      Farm      @relation(fields: [farmId], references: [id])
  type      String
  name      String
  unit      String?
  createdAt DateTime  @default(now())
  readings  Reading[]
}

model Reading {
  id       String   @id @default(cuid())
  sensorId String
  sensor   Sensor   @relation(fields: [sensorId], references: [id])
  value    Float
  ts       DateTime @default(now())
}

model NucIntegration {
  id        String             @id @default(cuid())
  nucId     String
  nuc       Nuc                @relation(fields: [nucId], references: [id])

  kind      IntegrationKind
  name      String?

  // Configuração pública (não sensível)
  config    Json?
  // Segredos (API keys, passwords) — guardar cifrado na app
  secrets   Json?

  status    IntegrationStatus  @default(DISABLED)
  lastSync  DateTime?
  lastError String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([nucId])
}
